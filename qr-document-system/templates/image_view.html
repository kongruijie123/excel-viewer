<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ doc_data.filename }} - PDFé¢„è§ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #2d2d2d;
            color: white;
            min-height: 100vh;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-nav {
            background: #1a1a1a;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
        }

        .file-info h1 {
            font-size: 1.2em;
            color: #fff;
        }

        .file-info p {
            font-size: 0.9em;
            color: #bbb;
            margin-top: 5px;
        }

        .nav-actions {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: #0078d4;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background 0.2s;
        }

        .nav-btn:hover {
            background: #106ebe;
        }

        /* å·¥å…·æ  */
        .toolbar {
            background: #333;
            padding: 12px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            border-bottom: 1px solid #444;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar-btn {
            padding: 8px 16px;
            background: #555;
            color: white;
            border: 1px solid #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: #666;
        }

        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-counter {
            font-weight: 600;
            color: #fff;
            font-size: 1em;
        }

        /* ä¸»è¦å†…å®¹åŒº */
        .viewer-container {
            height: calc(100vh - 140px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .page-display {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            transition: transform 0.3s ease;
            cursor: zoom-in;
        }

        .page-display.zoomed {
            cursor: zoom-out;
        }

        /* ç¼©æ”¾æ§åˆ¶ */
        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .zoom-btn:hover {
            background: #106ebe;
        }

        /* ç¼©ç•¥å›¾æ¡ */
        .thumbnail-strip {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            padding: 10px 20px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            max-height: 100px;
        }

        .thumbnail {
            min-width: 60px;
            height: 80px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
            object-fit: contain;
        }

        .thumbnail.active {
            border-color: #0078d4;
        }

        .thumbnail:hover {
            border-color: #666;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #333;
            border-top: 4px solid #0078d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .top-nav {
                flex-direction: column;
                gap: 10px;
                padding: 10px 15px;
            }

            .toolbar {
                flex-wrap: wrap;
                padding: 10px 15px;
            }

            .viewer-container {
                height: calc(100vh - 180px);
                padding: 10px;
            }

            .zoom-controls {
                bottom: 110px;
                right: 10px;
            }
        }

        /* å…¨å±æ¨¡å¼ */
        .fullscreen {
            background: #000;
        }

        .fullscreen .top-nav,
        .fullscreen .toolbar,
        .fullscreen .thumbnail-strip {
            display: none;
        }

        .fullscreen .viewer-container {
            height: 100vh;
        }
    </style>
</head>
<body>
    <!-- æ•°æ®ä¼ é€’å®¹å™¨ - ä½¿ç”¨HTML dataå±æ€§ -->
    <div id="document-data" style="display: none;"
         data-filename="{{ doc_data.filename }}"
         data-page-count="{{ doc_data.page_count }}"
         data-uploaded-at="{{ doc_data.uploaded_at }}"
         data-session-id="{{ session_data.session_id }}">
        {% for image in doc_data.content %}
        <div class="image-item" data-index="{{ loop.index0 }}" data-src="{{ image }}"></div>
        {% endfor %}
    </div>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="top-nav">
        <div class="file-info">
            <h1>ğŸ“„ {{ doc_data.filename }}</h1>
            <p>å…± {{ doc_data.page_count }} é¡µ | ä¸Šä¼ æ—¶é—´: {{ doc_data.uploaded_at }}</p>
        </div>
        <div class="nav-actions">
            <a href="/view/{{ session_data.session_id }}" class="nav-btn">â† è¿”å›åˆ—è¡¨</a>
            <a href="/qr-document-system/static" class="nav-btn">ğŸ  ä¸»é¡µ</a>
        </div>
    </div>

    <!-- å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="previousPage()" id="prev-btn">â† ä¸Šä¸€é¡µ</button>
            <div class="page-counter" id="page-counter">1 / {{ doc_data.page_count }}</div>
            <button class="toolbar-btn" onclick="nextPage()" id="next-btn">ä¸‹ä¸€é¡µ â†’</button>
        </div>

        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="zoomOut()">ğŸ”-</button>
            <span id="zoom-display">100%</span>
            <button class="toolbar-btn" onclick="zoomIn()">ğŸ”+</button>
            <button class="toolbar-btn" onclick="resetZoom()">é‡ç½®</button>
        </div>

        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="toggleFullscreen()">å…¨å±</button>
            <button class="toolbar-btn" onclick="downloadCurrentPage()">ä¸‹è½½å½“å‰é¡µ</button>
        </div>
    </div>

    <!-- ä¸»è¦æŸ¥çœ‹åŒºåŸŸ -->
    <div class="viewer-container">
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>åŠ è½½ä¸­...</p>
        </div>

        <img class="page-display" id="page-display"
             onclick="toggleZoom()"
             style="display: none;"
             alt="æ–‡æ¡£é¡µé¢">
    </div>

    <!-- ç¼©æ”¾æ§åˆ¶ -->
    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()" title="æ”¾å¤§">+</button>
        <button class="zoom-btn" onclick="resetZoom()" title="é€‚åˆçª—å£">âŒ‚</button>
        <button class="zoom-btn" onclick="zoomOut()" title="ç¼©å°">-</button>
    </div>

    <!-- ç¼©ç•¥å›¾å¯¼èˆªæ¡ -->
    <div class="thumbnail-strip" id="thumbnail-strip" style="display: none;">
        <!-- ç¼©ç•¥å›¾å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>

    <script>
        // ä»HTML dataå±æ€§è¯»å–æ–‡æ¡£ä¿¡æ¯
        function getDocumentData() {
            const dataContainer = document.getElementById('document-data');
            if (!dataContainer) {
                return {
                    filename: 'æœªçŸ¥æ–‡æ¡£',
                    pageCount: 0,
                    uploadedAt: '',
                    sessionId: '',
                    images: []
                };
            }

            // è¯»å–åŸºæœ¬ä¿¡æ¯
            const filename = dataContainer.getAttribute('data-filename') || 'æœªçŸ¥æ–‡æ¡£';
            const pageCount = parseInt(dataContainer.getAttribute('data-page-count')) || 0;
            const uploadedAt = dataContainer.getAttribute('data-uploaded-at') || '';
            const sessionId = dataContainer.getAttribute('data-session-id') || '';

            // è¯»å–å›¾ç‰‡åˆ—è¡¨
            const imageItems = dataContainer.querySelectorAll('.image-item');
            const images = [];
            imageItems.forEach(item => {
                const src = item.getAttribute('data-src');
                if (src) {
                    images.push(src);
                }
            });

            return {
                filename,
                pageCount,
                uploadedAt,
                sessionId,
                images
            };
        }

        // å…¨å±€å˜é‡
        const documentData = getDocumentData();
        const images = documentData.images;
        let currentPage = 1;
        let totalPages = documentData.pageCount;
        let currentZoom = 1;
        let isZoomed = false;

        // DOMå…ƒç´ 
        const pageDisplay = document.getElementById('page-display');
        const pageCounter = document.getElementById('page-counter');
        const zoomDisplay = document.getElementById('zoom-display');
        const loading = document.getElementById('loading');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const thumbnailStrip = document.getElementById('thumbnail-strip');

        // æ˜¾ç¤ºæŒ‡å®šé¡µé¢
        function showPage(pageNum) {
            if (pageNum < 1 || pageNum > totalPages || totalPages === 0) return;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loading.style.display = 'block';
            pageDisplay.style.display = 'none';

            // æ›´æ–°å›¾ç‰‡
            pageDisplay.onload = function() {
                loading.style.display = 'none';
                pageDisplay.style.display = 'block';
            };

            pageDisplay.onerror = function() {
                loading.innerHTML = '<p>å›¾ç‰‡åŠ è½½å¤±è´¥</p>';
            };

            pageDisplay.src = images[pageNum - 1];
            pageDisplay.alt = `é¡µé¢ ${pageNum}`;

            // æ›´æ–°é¡µé¢è®¡æ•°
            currentPage = pageNum;
            pageCounter.textContent = `${pageNum} / ${totalPages}`;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            prevBtn.disabled = (pageNum === 1);
            nextBtn.disabled = (pageNum === totalPages);

            // æ›´æ–°ç¼©ç•¥å›¾é€‰ä¸­çŠ¶æ€
            updateThumbnails();

            console.log(`æ˜¾ç¤ºç¬¬ ${pageNum} é¡µ`);
        }

        // ç”Ÿæˆç¼©ç•¥å›¾
        function generateThumbnails() {
            if (totalPages <= 1) return;

            let thumbnailHTML = '';
            for (let i = 0; i < totalPages; i++) {
                const activeClass = i === 0 ? ' active' : '';
                thumbnailHTML += `
                    <img class="thumbnail${activeClass}"
                         src="${images[i]}"
                         onclick="goToPage(${i + 1})"
                         alt="é¡µé¢ ${i + 1}">
                `;
            }

            thumbnailStrip.innerHTML = thumbnailHTML;
            thumbnailStrip.style.display = 'flex';
        }

        // æ›´æ–°ç¼©ç•¥å›¾é€‰ä¸­çŠ¶æ€
        function updateThumbnails() {
            const thumbnails = document.querySelectorAll('.thumbnail');
            thumbnails.forEach((thumb, index) => {
                if (index + 1 === currentPage) {
                    thumb.classList.add('active');
                } else {
                    thumb.classList.remove('active');
                }
            });
        }

        // é¡µé¢å¯¼èˆª
        function previousPage() {
            if (currentPage > 1) {
                showPage(currentPage - 1);
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                showPage(currentPage + 1);
            }
        }

        function goToPage(pageNum) {
            showPage(pageNum);
        }

        // ç¼©æ”¾åŠŸèƒ½
        function zoomIn() {
            currentZoom = Math.min(currentZoom + 0.25, 3);
            applyZoom();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom - 0.25, 0.25);
            applyZoom();
        }

        function resetZoom() {
            currentZoom = 1;
            isZoomed = false;
            applyZoom();
        }

        function toggleZoom() {
            if (isZoomed) {
                resetZoom();
            } else {
                currentZoom = 1.5;
                isZoomed = true;
                applyZoom();
            }
        }

        function applyZoom() {
            pageDisplay.style.transform = `scale(${currentZoom})`;
            zoomDisplay.textContent = Math.round(currentZoom * 100) + '%';

            if (currentZoom > 1) {
                pageDisplay.classList.add('zoomed');
                isZoomed = true;
            } else {
                pageDisplay.classList.remove('zoomed');
                isZoomed = false;
            }
        }

        // å…¨å±åŠŸèƒ½
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('å…¨å±æ¨¡å¼ä¸æ”¯æŒ:', err);
                });
                document.body.classList.add('fullscreen');
            } else {
                document.exitFullscreen();
                document.body.classList.remove('fullscreen');
            }
        }

        // ä¸‹è½½å½“å‰é¡µé¢
        function downloadCurrentPage() {
            if (images[currentPage - 1]) {
                const link = document.createElement('a');
                link.href = images[currentPage - 1];
                link.download = `${documentData.filename}_page_${currentPage}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(event) {
            switch(event.key) {
                case 'ArrowLeft':
                case 'ArrowUp':
                    event.preventDefault();
                    previousPage();
                    break;
                case 'ArrowRight':
                case 'ArrowDown':
                    event.preventDefault();
                    nextPage();
                    break;
                case 'F11':
                    event.preventDefault();
                    toggleFullscreen();
                    break;
                case '+':
                case '=':
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        zoomIn();
                    }
                    break;
                case '-':
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        zoomOut();
                    }
                    break;
                case '0':
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        resetZoom();
                    }
                    break;
                case 'Home':
                    event.preventDefault();
                    showPage(1);
                    break;
                case 'End':
                    event.preventDefault();
                    showPage(totalPages);
                    break;
            }
        });

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('PDFæŸ¥çœ‹å™¨åˆå§‹åŒ–', {
                filename: documentData.filename,
                totalPages: totalPages,
                imagesCount: images.length
            });

            if (totalPages > 0 && images.length > 0) {
                generateThumbnails();
                showPage(1);
            } else {
                loading.innerHTML = '<p>æ²¡æœ‰æ‰¾åˆ°é¡µé¢å†…å®¹</p>';
            }
        });

        // ç›‘å¬å…¨å±å˜åŒ–
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement) {
                document.body.classList.remove('fullscreen');
            }
        });
    </script>
</body>
</html>