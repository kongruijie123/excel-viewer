<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ doc_data.filename }} - Office预览</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #1e1e1e;
            color: #ffffff;
            min-height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: #2d2d2d;
            padding: 12px 20px;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            position: relative;
        }

        .file-info h1 {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
        }

        .file-info p {
            font-size: 13px;
            color: #cccccc;
            margin-top: 2px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            padding: 6px 12px;
            background: #0078d4;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 13px;
            transition: background 0.2s;
        }

        .header-btn:hover {
            background: #106ebe;
        }

        /* Toolbar */
        .toolbar {
            background: #2d2d2d;
            padding: 8px 20px;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-btn {
            padding: 6px 12px;
            background: #404040;
            color: white;
            border: 1px solid #505050;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .toolbar-btn:hover:not(:disabled) {
            background: #505050;
        }

        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-counter {
            font-weight: 500;
            color: #ffffff;
            min-width: 80px;
            text-align: center;
        }

        /* Main viewer */
        .viewer-container {
            height: calc(100vh - 100px);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
            background: #1e1e1e;
        }

        .page-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 100%;
            max-height: 100%;
            position: relative;
        }

        .page-image {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 8px;
            transition: transform 0.3s ease;
        }

        /* Zoom controls */
        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 8px;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 100;
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.2s;
        }

        .zoom-btn:hover {
            background: #106ebe;
        }

        /* Loading state */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 200;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #404040;
            border-top: 3px solid #0078d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .header {
                padding: 8px 12px;
            }

            .toolbar {
                padding: 6px 12px;
                flex-wrap: wrap;
                gap: 8px;
            }

            .viewer-container {
                padding: 10px;
                height: calc(100vh - 110px);
            }

            .zoom-controls {
                bottom: 10px;
                right: 10px;
            }
        }

        /* Error state */
        .error-message {
            text-align: center;
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="file-info">
            <h1>{{ doc_data.filename }}</h1>
            <p>共 {{ doc_data.page_count }} 页 | {{ doc_data.uploaded_at }}</p>
        </div>
        <div class="header-actions">
            <a href="/view/{{ session_data.session_id }}" class="header-btn">返回</a>
            <a href="/" class="header-btn">主页</a>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="toolbar-group">
            <button class="toolbar-btn" id="prev-btn" onclick="previousPage()">← 上一页</button>
            <div class="page-counter" id="page-counter">1 / {{ doc_data.page_count }}</div>
            <button class="toolbar-btn" id="next-btn" onclick="nextPage()">下一页 →</button>
        </div>

        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="zoomOut()">缩小</button>
            <span id="zoom-display">100%</span>
            <button class="toolbar-btn" onclick="zoomIn()">放大</button>
            <button class="toolbar-btn" onclick="fitToWidth()">适合宽度</button>
        </div>

        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="toggleFullscreen()">全屏</button>
            <button class="toolbar-btn" onclick="downloadPage()">下载</button>
        </div>
    </div>

    <!-- Document data -->
    <div id="document-data" style="display: none;">
        {% for image in doc_data.images %}
        <div class="page-data" data-src="{{ image }}"></div>
        {% endfor %}
    </div>

    <!-- Main viewer -->
    <div class="viewer-container" id="viewer-container">
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>正在加载文档...</p>
        </div>

        <div class="page-container" id="page-container" style="display: none;">
            <img class="page-image" id="page-image" alt="文档页面">
        </div>
    </div>

    <!-- Zoom controls -->
    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()" title="放大">+</button>
        <button class="zoom-btn" onclick="fitToWidth()" title="适合宽度">⌂</button>
        <button class="zoom-btn" onclick="zoomOut()" title="缩小">−</button>
    </div>

    <script>
        // Get document data
        function getDocumentData() {
            const pageElements = document.querySelectorAll('.page-data');
            const pages = [];
            pageElements.forEach(el => {
                pages.push(el.getAttribute('data-src'));
            });
            return pages;
        }

        // Global variables
        const pages = getDocumentData();
        const totalPages = pages.length;
        let currentPage = 1;
        let currentZoom = 1;
        let isFullscreen = false;

        // DOM elements
        const loading = document.getElementById('loading');
        const pageContainer = document.getElementById('page-container');
        const pageImage = document.getElementById('page-image');
        const pageCounter = document.getElementById('page-counter');
        const zoomDisplay = document.getElementById('zoom-display');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        // Show specific page
        function showPage(pageNum) {
            if (pageNum < 1 || pageNum > totalPages) return;

            loading.style.display = 'block';
            pageContainer.style.display = 'none';

            pageImage.onload = function() {
                loading.style.display = 'none';
                pageContainer.style.display = 'block';
                applyZoom();
            };

            pageImage.onerror = function() {
                loading.innerHTML = '<p class="error-message">图片加载失败</p>';
            };

            pageImage.src = pages[pageNum - 1];
            currentPage = pageNum;

            // Update UI
            pageCounter.textContent = `${pageNum} / ${totalPages}`;
            prevBtn.disabled = (pageNum === 1);
            nextBtn.disabled = (pageNum === totalPages);
        }

        // Navigation
        function previousPage() {
            if (currentPage > 1) {
                showPage(currentPage - 1);
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                showPage(currentPage + 1);
            }
        }

        // Zoom functions
        function zoomIn() {
            currentZoom = Math.min(currentZoom * 1.2, 3);
            applyZoom();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom / 1.2, 0.3);
            applyZoom();
        }

        function fitToWidth() {
            currentZoom = 1;
            applyZoom();
        }

        function applyZoom() {
            pageImage.style.transform = `scale(${currentZoom})`;
            zoomDisplay.textContent = Math.round(currentZoom * 100) + '%';
        }

        // Fullscreen
        function toggleFullscreen() {
            try {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                    isFullscreen = true;
                } else {
                    document.exitFullscreen();
                    isFullscreen = false;
                }
            } catch (error) {
                console.warn('Fullscreen not supported:', error);
            }
        }

        // Download current page
        function downloadPage() {
            const link = document.createElement('a');
            link.href = pages[currentPage - 1];
            link.download = `page_${currentPage}.png`;
            link.click();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            switch(event.key) {
                case 'ArrowLeft':
                case 'ArrowUp':
                    event.preventDefault();
                    previousPage();
                    break;
                case 'ArrowRight':
                case 'ArrowDown':
                    event.preventDefault();
                    nextPage();
                    break;
                case '+':
                case '=':
                    if (event.ctrlKey) {
                        event.preventDefault();
                        zoomIn();
                    }
                    break;
                case '-':
                    if (event.ctrlKey) {
                        event.preventDefault();
                        zoomOut();
                    }
                    break;
                case '0':
                    if (event.ctrlKey) {
                        event.preventDefault();
                        fitToWidth();
                    }
                    break;
                case 'F11':
                    event.preventDefault();
                    toggleFullscreen();
                    break;
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log(`Document loaded: ${totalPages} pages`);

            if (totalPages > 0) {
                showPage(1);
            } else {
                loading.innerHTML = '<p class="error-message">没有找到文档内容</p>';
            }
        });

        // Handle fullscreen changes
        document.addEventListener('fullscreenchange', function() {
            isFullscreen = !!document.fullscreenElement;
        });
    </script>
</body>
</html>