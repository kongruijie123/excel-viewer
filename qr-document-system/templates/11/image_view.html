<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ doc_data.filename }} - PDFÈ¢ÑËßà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #2d2d2d;
            color: white;
            min-height: 100vh;
        }

        /* È°∂ÈÉ®ÂØºËà™Ê†è */
        .top-nav {
            background: #1a1a1a;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
        }

        .file-info h1 {
            font-size: 1.2em;
            color: #fff;
        }

        .file-info p {
            font-size: 0.9em;
            color: #bbb;
            margin-top: 5px;
        }

        .nav-actions {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: #0078d4;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background 0.2s;
        }

        .nav-btn:hover {
            background: #106ebe;
        }

        /* Â∑•ÂÖ∑Ê†è */
        .toolbar {
            background: #333;
            padding: 12px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            border-bottom: 1px solid #444;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar-btn {
            padding: 8px 16px;
            background: #555;
            color: white;
            border: 1px solid #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: #666;
        }

        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-counter {
            font-weight: 600;
            color: #fff;
            font-size: 1em;
        }

        /* ‰∏ªË¶ÅÂÜÖÂÆπÂå∫ */
        .viewer-container {
            height: calc(100vh - 140px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .page-display {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            transition: transform 0.3s ease;
            cursor: zoom-in;
        }

        .page-display.zoomed {
            cursor: zoom-out;
        }

        /* Áº©ÊîæÊéßÂà∂ */
        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .zoom-btn:hover {
            background: #106ebe;
        }

        /* Áº©Áï•ÂõæÊù° */
        .thumbnail-strip {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            padding: 10px 20px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            max-height: 100px;
        }

        .thumbnail {
            min-width: 60px;
            height: 80px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
            object-fit: contain;
        }

        .thumbnail.active {
            border-color: #0078d4;
        }

        .thumbnail:hover {
            border-color: #666;
        }

        /* Âä†ËΩΩÁä∂ÊÄÅ */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #333;
            border-top: 4px solid #0078d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .top-nav {
                flex-direction: column;
                gap: 10px;
                padding: 10px 15px;
            }

            .toolbar {
                flex-wrap: wrap;
                padding: 10px 15px;
            }

            .viewer-container {
                height: calc(100vh - 180px);
                padding: 10px;
            }

            .zoom-controls {
                bottom: 110px;
                right: 10px;
            }
        }

        /* ÂÖ®Â±èÊ®°Âºè */
        .fullscreen {
            background: #000;
        }

        .fullscreen .top-nav,
        .fullscreen .toolbar,
        .fullscreen .thumbnail-strip {
            display: none;
        }

        .fullscreen .viewer-container {
            height: 100vh;
        }
    </style>
</head>
<body>
    <!-- Êï∞ÊçÆ‰º†ÈÄíÂÆπÂô® - ‰ΩøÁî®HTML dataÂ±ûÊÄß -->
    <div id="document-data" style="display: none;"
         data-filename="{{ doc_data.filename }}"
         data-page-count="{{ doc_data.page_count }}"
         data-uploaded-at="{{ doc_data.uploaded_at }}"
         data-session-id="{{ session_data.session_id }}">
        {% for image in doc_data.content %}
        <div class="image-item" data-index="{{ loop.index0 }}" data-src="{{ image }}"></div>
        {% endfor %}
    </div>

    <!-- È°∂ÈÉ®ÂØºËà™ -->
    <div class="top-nav">
        <div class="file-info">
            <h1>üìÑ {{ doc_data.filename }}</h1>
            <p>ÂÖ± {{ doc_data.page_count }} È°µ | ‰∏ä‰º†Êó∂Èó¥: {{ doc_data.uploaded_at }}</p>
        </div>
        <div class="nav-actions">
            <a href="/view/{{ session_data.session_id }}" class="nav-btn">‚Üê ËøîÂõûÂàóË°®</a>
            <a href="/qr-document-system/static" class="nav-btn">üè† ‰∏ªÈ°µ</a>
        </div>
    </div>

    <!-- Â∑•ÂÖ∑Ê†è -->
    <div class="toolbar">
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="previousPage()" id="prev-btn">‚Üê ‰∏ä‰∏ÄÈ°µ</button>
            <div class="page-counter" id="page-counter">1 / {{ doc_data.page_count }}</div>
            <button class="toolbar-btn" onclick="nextPage()" id="next-btn">‰∏ã‰∏ÄÈ°µ ‚Üí</button>
        </div>

        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="zoomOut()">üîç-</button>
            <span id="zoom-display">100%</span>
            <button class="toolbar-btn" onclick="zoomIn()">üîç+</button>
            <button class="toolbar-btn" onclick="resetZoom()">ÈáçÁΩÆ</button>
        </div>

        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="toggleFullscreen()">ÂÖ®Â±è</button>
            <button class="toolbar-btn" onclick="downloadCurrentPage()">‰∏ãËΩΩÂΩìÂâçÈ°µ</button>
        </div>
    </div>

    <!-- ‰∏ªË¶ÅÊü•ÁúãÂå∫Âüü -->
    <div class="viewer-container">
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>Âä†ËΩΩ‰∏≠...</p>
        </div>

        <img class="page-display" id="page-display"
             onclick="toggleZoom()"
             style="display: none;"
             alt="ÊñáÊ°£È°µÈù¢">
    </div>

    <!-- Áº©ÊîæÊéßÂà∂ -->
    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()" title="ÊîæÂ§ß">+</button>
        <button class="zoom-btn" onclick="resetZoom()" title="ÈÄÇÂêàÁ™óÂè£">‚åÇ</button>
        <button class="zoom-btn" onclick="zoomOut()" title="Áº©Â∞è">-</button>
    </div>

    <!-- Áº©Áï•ÂõæÂØºËà™Êù° -->
    <div class="thumbnail-strip" id="thumbnail-strip" style="display: none;">
        <!-- Áº©Áï•ÂõæÂ∞ÜÁî±JavaScriptÂä®ÊÄÅÁîüÊàê -->
    </div>

    <script>
        // ‰ªéHTML dataÂ±ûÊÄßËØªÂèñÊñáÊ°£‰ø°ÊÅØ
        function getDocumentData() {
            const dataContainer = document.getElementById('document-data');
            if (!dataContainer) {
                return {
                    filename: 'Êú™Áü•ÊñáÊ°£',
                    pageCount: 0,
                    uploadedAt: '',
                    sessionId: '',
                    images: []
                };
            }

            // ËØªÂèñÂü∫Êú¨‰ø°ÊÅØ
            const filename = dataContainer.getAttribute('data-filename') || 'Êú™Áü•ÊñáÊ°£';
            const pageCount = parseInt(dataContainer.getAttribute('data-page-count')) || 0;
            const uploadedAt = dataContainer.getAttribute('data-uploaded-at') || '';
            const sessionId = dataContainer.getAttribute('data-session-id') || '';

            // ËØªÂèñÂõæÁâáÂàóË°®
            const imageItems = dataContainer.querySelectorAll('.image-item');
            const images = [];
            imageItems.forEach(item => {
                const src = item.getAttribute('data-src');
                if (src) {
                    images.push(src);
                }
            });

            return {
                filename,
                pageCount,
                uploadedAt,
                sessionId,
                images
            };
        }

        // ÂÖ®Â±ÄÂèòÈáè
        const documentData = getDocumentData();
        const images = documentData.images;
        let currentPage = 1;
        let totalPages = documentData.pageCount;
        let currentZoom = 1;
        let isZoomed = false;

        // DOMÂÖÉÁ¥†
        const pageDisplay = document.getElementById('page-display');
        const pageCounter = document.getElementById('page-counter');
        const zoomDisplay = document.getElementById('zoom-display');
        const loading = document.getElementById('loading');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const thumbnailStrip = document.getElementById('thumbnail-strip');

        // ÊòæÁ§∫ÊåáÂÆöÈ°µÈù¢
        function showPage(pageNum) {
            if (pageNum < 1 || pageNum > totalPages || totalPages === 0) return;

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            loading.style.display = 'block';
            pageDisplay.style.display = 'none';

            // Êõ¥Êñ∞ÂõæÁâá
            pageDisplay.onload = function() {
                loading.style.display = 'none';
                pageDisplay.style.display = 'block';
            };

            pageDisplay.onerror = function() {
                loading.innerHTML = '<p>ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•</p>';
            };

            pageDisplay.src = images[pageNum - 1];
            pageDisplay.alt = `È°µÈù¢ ${pageNum}`;

            // Êõ¥Êñ∞È°µÈù¢ËÆ°Êï∞
            currentPage = pageNum;
            pageCounter.textContent = `${pageNum} / ${totalPages}`;

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            prevBtn.disabled = (pageNum === 1);
            nextBtn.disabled = (pageNum === totalPages);

            // Êõ¥Êñ∞Áº©Áï•ÂõæÈÄâ‰∏≠Áä∂ÊÄÅ
            updateThumbnails();

            console.log(`ÊòæÁ§∫Á¨¨ ${pageNum} È°µ`);
        }

        // ÁîüÊàêÁº©Áï•Âõæ
        function generateThumbnails() {
            if (totalPages <= 1) return;

            let thumbnailHTML = '';
            for (let i = 0; i < totalPages; i++) {
                const activeClass = i === 0 ? ' active' : '';
                thumbnailHTML += `
                    <img class="thumbnail${activeClass}"
                         src="${images[i]}"
                         onclick="goToPage(${i + 1})"
                         alt="È°µÈù¢ ${i + 1}">
                `;
            }

            thumbnailStrip.innerHTML = thumbnailHTML;
            thumbnailStrip.style.display = 'flex';
        }

        // Êõ¥Êñ∞Áº©Áï•ÂõæÈÄâ‰∏≠Áä∂ÊÄÅ
        function updateThumbnails() {
            const thumbnails = document.querySelectorAll('.thumbnail');
            thumbnails.forEach((thumb, index) => {
                if (index + 1 === currentPage) {
                    thumb.classList.add('active');
                } else {
                    thumb.classList.remove('active');
                }
            });
        }

        // È°µÈù¢ÂØºËà™
        function previousPage() {
            if (currentPage > 1) {
                showPage(currentPage - 1);
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                showPage(currentPage + 1);
            }
        }

        function goToPage(pageNum) {
            showPage(pageNum);
        }

        // Áº©ÊîæÂäüËÉΩ
        function zoomIn() {
            currentZoom = Math.min(currentZoom + 0.25, 3);
            applyZoom();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom - 0.25, 0.25);
            applyZoom();
        }

        function resetZoom() {
            currentZoom = 1;
            isZoomed = false;
            applyZoom();
        }

        function toggleZoom() {
            if (isZoomed) {
                resetZoom();
            } else {
                currentZoom = 1.5;
                isZoomed = true;
                applyZoom();
            }
        }

        function applyZoom() {
            pageDisplay.style.transform = `scale(${currentZoom})`;
            zoomDisplay.textContent = Math.round(currentZoom * 100) + '%';

            if (currentZoom > 1) {
                pageDisplay.classList.add('zoomed');
                isZoomed = true;
            } else {
                pageDisplay.classList.remove('zoomed');
                isZoomed = false;
            }
        }

        // ÂÖ®Â±èÂäüËÉΩ
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('ÂÖ®Â±èÊ®°Âºè‰∏çÊîØÊåÅ:', err);
                });
                document.body.classList.add('fullscreen');
            } else {
                document.exitFullscreen();
                document.body.classList.remove('fullscreen');
            }
        }

        // ‰∏ãËΩΩÂΩìÂâçÈ°µÈù¢
        function downloadCurrentPage() {
            if (images[currentPage - 1]) {
                const link = document.createElement('a');
                link.href = images[currentPage - 1];
                link.download = `${documentData.filename}_page_${currentPage}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // ÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', function(event) {
            switch(event.key) {
                case 'ArrowLeft':
                case 'ArrowUp':
                    event.preventDefault();
                    previousPage();
                    break;
                case 'ArrowRight':
                case 'ArrowDown':
                    event.preventDefault();
                    nextPage();
                    break;
                case 'F11':
                    event.preventDefault();
                    toggleFullscreen();
                    break;
                case '+':
                case '=':
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        zoomIn();
                    }
                    break;
                case '-':
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        zoomOut();
                    }
                    break;
                case '0':
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        resetZoom();
                    }
                    break;
                case 'Home':
                    event.preventDefault();
                    showPage(1);
                    break;
                case 'End':
                    event.preventDefault();
                    showPage(totalPages);
                    break;
            }
        });

        // È°µÈù¢ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('PDFÊü•ÁúãÂô®ÂàùÂßãÂåñ', {
                filename: documentData.filename,
                totalPages: totalPages,
                imagesCount: images.length
            });

            if (totalPages > 0 && images.length > 0) {
                generateThumbnails();
                showPage(1);
            } else {
                loading.innerHTML = '<p>Ê≤°ÊúâÊâæÂà∞È°µÈù¢ÂÜÖÂÆπ</p>';
            }
        });

        // ÁõëÂê¨ÂÖ®Â±èÂèòÂåñ
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement) {
                document.body.classList.remove('fullscreen');
            }
        });
    </script>
</body>
</html>